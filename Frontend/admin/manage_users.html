<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - BloodBridge</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">BloodBridge</div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="manage_users.html">Users</a></li>
                <li><a href="manage_inventory.html">Inventory</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div style="margin: 30px 0;">
            <h1 style="color: var(--blood-red);">User Management ðŸ‘¥</h1>
            <p style="color: var(--text-gray);">View and manage all users</p>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Filter -->
        <div class="card">
            <div class="flex gap-10 align-center" style="flex-wrap: wrap;">
                <label style="color: var(--text-gray);">Filter by Role:</label>
                <select id="roleFilter" class="form-group" style="max-width: 200px; margin: 0;">
                    <option value="">All Users</option>
                    <option value="donor">Donors</option>
                    <option value="receiver">Receivers</option>
                    <option value="admin">Admins</option>
                </select>
                <button class="btn btn-primary" onclick="loadUsers()">Apply Filter</button>
            </div>
        </div>

        <!-- Donors -->
        <div class="card" style="margin-top: 30px;">
            <h2 class="card-title">Donors</h2>
            <div class="loading" id="donorsLoading">
                <div class="spinner"></div>
            </div>
            <div class="table-container" id="donorsTable" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Blood Type</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Donations</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="donorsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Receivers -->
        <div class="card" style="margin-top: 30px;">
            <h2 class="card-title">Receivers</h2>
            <div class="loading" id="receiversLoading">
                <div class="spinner"></div>
            </div>
            <div class="table-container" id="receiversTable" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Blood Type</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Urgency</th>
                            <th>Condition</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="receiversBody"></tbody>
                </table>
            </div>
        </div>

        <!-- All Users -->
        <div class="card" id="allUsersCard" style="margin-top: 30px; display: none;">
            <h2 class="card-title">All Users</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="allUsersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="color: var(--blood-red); margin-bottom: 20px;">Confirm Delete</h2>
            <p style="color: var(--text-gray); margin-bottom: 30px;">
                Are you sure you want to delete this user? This action cannot be undone.
            </p>
            <div class="flex gap-10">
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        protectPage('admin');

        let userToDelete = null;

        async function loadUsers() {
            const role = document.getElementById('roleFilter').value;
            
            if (role) {
                // Load filtered users
                const result = await apiCall(`/admin/users?role=${role}`);
                if (result.ok) {
                    displayFilteredUsers(result.data);
                }
            } else {
                // Load all by type
                loadDonors();
                loadReceivers();
            }
        }

        async function loadDonors() {
            document.getElementById('donorsLoading').classList.add('show');
            const result = await apiCall('/admin/donors');
            document.getElementById('donorsLoading').classList.remove('show');
            
            if (result.ok) {
                const donors = result.data;
                const tbody = document.getElementById('donorsBody');
                
                tbody.innerHTML = donors.map(d => `
                    <tr>
                        <td>${d.donor_id}</td>
                        <td>${d.full_name}</td>
                        <td>${d.email}</td>
                        <td><span class="blood-badge">${d.blood_type}</span></td>
                        <td>${d.phone || '-'}</td>
                        <td>${d.city || '-'}</td>
                        <td>${d.total_donations || 0}</td>
                        <td><span class="status-badge status-${d.is_eligible ? 'approved' : 'pending'}">${d.is_eligible ? 'Eligible' : 'Not Eligible'}</span></td>
                        <td><button class="btn btn-danger" style="padding: 5px 15px;" onclick="deleteUser(${d.user_id})">Delete</button></td>
                    </tr>
                `).join('');
                
                document.getElementById('donorsTable').style.display = 'block';
            }
        }

        async function loadReceivers() {
            document.getElementById('receiversLoading').classList.add('show');
            const result = await apiCall('/admin/receivers');
            document.getElementById('receiversLoading').classList.remove('show');
            
            if (result.ok) {
                const receivers = result.data;
                const tbody = document.getElementById('receiversBody');
                
                tbody.innerHTML = receivers.map(r => `
                    <tr>
                        <td>${r.receiver_id}</td>
                        <td>${r.full_name}</td>
                        <td>${r.email}</td>
                        <td><span class="blood-badge">${r.blood_type}</span></td>
                        <td>${r.phone || '-'}</td>
                        <td>${r.city || '-'}</td>
                        <td><span class="status-badge status-${r.urgency_level}">${r.urgency_level}</span></td>
                        <td>${r.medical_condition || '-'}</td>
                        <td><button class="btn btn-danger" style="padding: 5px 15px;" onclick="deleteUser(${r.user_id})">Delete</button></td>
                    </tr>
                `).join('');
                
                document.getElementById('receiversTable').style.display = 'block';
            }
        }

        function displayFilteredUsers(users) {
            document.getElementById('donorsTable').style.display = 'none';
            document.getElementById('receiversTable').style.display = 'none';
            document.getElementById('allUsersCard').style.display = 'block';
            
            const tbody = document.getElementById('allUsersBody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.user_id}</td>
                    <td>${u.full_name}</td>
                    <td>${u.email}</td>
                    <td><span class="status-badge status-${u.role === 'admin' ? 'completed' : 'approved'}">${u.role}</span></td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.city || '-'}</td>
                    <td><span class="status-badge status-${u.is_active ? 'approved' : 'rejected'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td><button class="btn btn-danger" style="padding: 5px 15px;" onclick="deleteUser(${u.user_id})">Delete</button></td>
                </tr>
            `).join('');
        }

        function deleteUser(userId) {
            userToDelete = userId;
            document.getElementById('deleteModal').classList.add('show');
        }

        async function confirmDelete() {
            if (!userToDelete) return;
            
            const result = await apiCall(`/admin/users/${userToDelete}`, 'DELETE');
            
            closeModal();
            
            if (result.ok) {
                showAlert('User deleted successfully', 'success');
                loadUsers();
            } else {
                showAlert(result.data.error || 'Failed to delete user', 'error');
            }
            
            userToDelete = null;
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('show');
            userToDelete = null;
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type} show`;
            setTimeout(() => alertDiv.classList.remove('show'), 3000);
        }

        loadUsers();
    </script>
</body>
</html>