<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation History - BloodBridge</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">BloodBridge</div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="donate.html">Donate Blood</a></li>
                <li><a href="history.html">History</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div style="margin: 30px 0;">
            <h1 style="color: var(--blood-red);">Donation History </h1>
            <p style="color: var(--text-gray);">Track all your blood donations</p>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Stats -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-label">Total Donations</div>
                <div class="stat-number" id="totalDonations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lives Impacted</div>
                <div class="stat-number" id="livesImpacted">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Donation</div>
                <div class="stat-number" style="font-size: 20px;" id="lastDonation">Never</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Next Eligible</div>
                <div class="stat-number" style="font-size: 20px;" id="nextEligible">-</div>
            </div>
        </div>

        <!-- History Table -->
        <div class="card">
            <h2 class="card-title">All Donations</h2>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading history...</p>
            </div>

            <div class="table-container" id="historyTable" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Blood Type</th>
                            <th>Units</th>
                            <th>Type</th>
                            <th>Receiver</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>

            <div id="emptyState" style="display: none; text-align: center; padding: 40px;">
                <h3 style="color: var(--blood-red); margin-bottom: 10px;">No Donations Yet</h3>
                <p style="color: var(--text-gray); margin-bottom: 20px;">
                    Start saving lives by making your first donation!
                </p>
                <a href="donate.html" class="btn btn-primary">Donate Now</a>
            </div>
        </div>

        <!-- Impact Section -->
        <div class="card" style="margin-top: 30px; text-align: center; background: linear-gradient(135deg, var(--dark-red), var(--blood-red));">
            <h2 style="color: white; margin-bottom: 20px;">Your Impact </h2>
            <p style="color: white; font-size: 18px; line-height: 1.8;">
                Every donation can save up to <strong>3 lives</strong>.<br>
                Thank you for being a hero!
            </p>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        protectPage('donor');

        async function loadHistory() {
            const result = await apiCall('/donor/history');
            document.getElementById('loading').classList.remove('show');

            if (result.ok) {
                const transactions = result.data;
                
                if (transactions.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    const tbody = document.getElementById('historyBody');
                    tbody.innerHTML = transactions.map(t => `
                        <tr>
                            <td>${new Date(t.transaction_date).toLocaleDateString()}</td>
                            <td><span class="blood-badge">${t.blood_type}</span></td>
                            <td>${t.units}</td>
                            <td><span class="status-badge status-${t.transaction_type === 'direct' ? 'approved' : 'completed'}">${t.transaction_type}</span></td>
                            <td>${t.receiver_id ? `Receiver #${t.receiver_id}` : 'Inventory'}</td>
                            <td>${t.notes || '-'}</td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('historyTable').style.display = 'block';
                    
                    // Update stats
                    document.getElementById('totalDonations').textContent = transactions.length;
                    document.getElementById('livesImpacted').textContent = transactions.length * 3;
                    
                    if (transactions.length > 0) {
                        const lastDate = new Date(transactions[transactions.length - 1].transaction_date);
                        document.getElementById('lastDonation').textContent = lastDate.toLocaleDateString();
                        
                        const nextDate = new Date(lastDate);
                        nextDate.setDate(nextDate.getDate() + 90);
                        document.getElementById('nextEligible').textContent = nextDate.toLocaleDateString();
                    }
                }
            } else {
                showAlert('Failed to load history', 'error');
            }
        }

        async function loadProfile() {
            const result = await apiCall('/donor/profile');
            if (result.ok) {
                const profile = result.data;
                document.getElementById('totalDonations').textContent = profile.total_donations || 0;
                document.getElementById('livesImpacted').textContent = (profile.total_donations || 0) * 3;
                
                if (profile.last_donation_date) {
                    const lastDate = new Date(profile.last_donation_date);
                    document.getElementById('lastDonation').textContent = lastDate.toLocaleDateString();
                    
                    const nextDate = new Date(lastDate);
                    nextDate.setDate(nextDate.getDate() + 90);
                    document.getElementById('nextEligible').textContent = nextDate.toLocaleDateString();
                }
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type} show`;
            setTimeout(() => alertDiv.classList.remove('show'), 5000);
        }

        loadProfile();
        loadHistory();
    </script>
</body>
</html>